LAB343: Modernizing .NET using Azure Migrate and GitHub Copilot tools

Modernizing .NET using Azure Migrate and GitHub Copilot tools
1 Hr 57 Min Remaining 
Modernizing .NET using Azure Migrate and GitHub Copilot tools
Welcome
Log In to the Virtual Machine.
Username : Admin
Password : Passw0rd!

Welcome to the Modernizing .NET Apps using Azure Migrate and GitHub Copilot tools Lab! In this lab, you will perform an assessment on three .NET applications, migrate two of the applications to Azure App Service, perform code scan using Azure Migrate application and code assessment for .NET, use GitHub Copilot chat for autocomplete-style suggestions and experiment with a few of the modernization features available in App Service. Please follow the steps below to get started on your journey.

Explore the applications
Go to the Windows Search bar and search for Internet Information Services (IIS) Manager. Open the Internet Information Services Manager.
Expand the connection on the left and then expand Sites. You will see three applications:
devshop, .NET Framework v4.8 application running on Port 80
aoiapp, .NET Framework v4.8 application running on Port 8000
Default web site, simple HTML application running on Port 9000 using Windows Authentication inetmgr.jpg
These applications are intended to demonstrate three scenarios:

An application that is ready to be migrated to Azure App Service with no modifications (devshop)
An application that is ready to be migrated, but requires minor modifications to work properly on App Service(aoiapp)
An application that is not ready to be migrated and requires major modifications to be migrated to App Service(Default web site)
Continue to the next step to begin assessing the three applications.

Modernizing .NET using Azure Migrate and GitHub Copilot tools
1 Hr 53 Min Remaining 
Assessment
During this part of the lab, you will run a PowerShell script that runs several baseline checks on the applications running in IIS. It will generate a json file that tells you about the migration status of each application.

This Lab is designed using PowerShell cmdlets only. AZ CLI usage may cause errors.

Open a new Windows PowerShell window in Admin mode by typing PowerShell into the Windows Search bar, right clicking on Windows PowerShell and selecting "Run as Administrator". Select Yes when prompted.
Change directory to the C:\scripts folder by running cd C:\scripts in the PowerShell window
Run the application assessment script by running .\Get-SiteReadiness.ps1 -OverwriteReadinessResults
After the script has completed, open the ReadinessResults.json file located in the same folder that was generated by the scripts by running code ReadinessResults.json.
You will see assessment results for the three applications:
default web site will indicate that it cannot be migrated due to Windows Authentication configuration & LocationTagCheck and also has warnings related to TCPPort.
devshop will indicate that it is fully ready to be migrated and generates no warnings or checks.
aoiapp will indicate that it could be migrated, but generates a warning about the port
Keep your PowerShell window open for the upcoming migration step and continue to the next step.


Modernizing .NET using Azure Migrate and GitHub Copilot tools
1 Hr 53 Min Remaining 
GitHub Copilot Configuration
Before proceeding with using Azure Migrate application and code assessment extension we need to connect and configure Copilot with an active Github Enterprise Account using the steps described below. Please ensure to follow all the steps sequently and exactly as described.

Open Microsoft Edge Browser and click https://github.com/enterprises/skillable-events/sso
GH1.png
On the next screen click continue
GH2.png
Sigin in with GitHub Username User1-51501459@LODSPRODMCA.onmicrosoft.com
GH3.png
Provide the GitHub Password as eS0qNr+D8!
GH4.png
Once authenticated you should see following screen. Click Yes (You can click No on other popups that appear.)
GH5.png
Finally you will be presented with following screen. Do NOT Close The Browser. If you do so subsequent steps will fail and you will be required to repeat steps 1-6 as described above.
GH6.png
Open Visual Studio 2022. Switch to GitHub Copilot chat window .
GH7.png
Open an existing solution C:\Users\Admin\source\repos\devShop\devShop\devShop.sln
GH8.png
On this screen click on "Add GitHub Account" button.
GH9.png
A new tab in Microsoft Edge browser will open. Click "Continue" next to the user name which is similar to User1-&&&&_MSFTGHE. This will ensure that GitHub Copilot is activated using the logged-in GitHub Enterprise user. If You have accidentaly closed the browser window please repeat step 1-6 and then return to step 10.
GH10.png
11.On the next screen click "Authorize GitHub"
GH11.png
12.On the next screen click "Open".
GH12.png
Next screen will configure OAUTH between GitHub and Visual Studio 2022. (A commend window will auto open and close. No action is required)
GH13.png
GitHub Copilot is now authenticated, configured and ready for use.
GH14.png
Continue to the next step.

Modernizing .NET using Azure Migrate and GitHub Copilot tools
1 Hr 49 Min Remaining 
GitHub Copilot Configuration
Before proceeding with using Azure Migrate application and code assessment extension we need to connect and configure Copilot with an active Github Enterprise Account using the steps described below. Please ensure to follow all the steps sequently and exactly as described.

Open Microsoft Edge Browser and click https://github.com/enterprises/skillable-events/sso
GH1.png
On the next screen click continue
GH2.png
Sigin in with GitHub Username User1-51501459@LODSPRODMCA.onmicrosoft.com
GH3.png
Provide the GitHub Password as eS0qNr+D8!
GH4.png
Once authenticated you should see following screen. Click Yes (You can click No on other popups that appear.)
GH5.png
Finally you will be presented with following screen. Do NOT Close The Browser. If you do so subsequent steps will fail and you will be required to repeat steps 1-6 as described above.
GH6.png
Open Visual Studio 2022. Switch to GitHub Copilot chat window .
GH7.png
Open an existing solution C:\Users\Admin\source\repos\devShop\devShop\devShop.sln
GH8.png
On this screen click on "Add GitHub Account" button.
GH9.png
A new tab in Microsoft Edge browser will open. Click "Continue" next to the user name which is similar to User1-&&&&_MSFTGHE. This will ensure that GitHub Copilot is activated using the logged-in GitHub Enterprise user. If You have accidentaly closed the browser window please repeat step 1-6 and then return to step 10.
GH10.png
11.On the next screen click "Authorize GitHub"
GH11.png
12.On the next screen click "Open".
GH12.png
Next screen will configure OAUTH between GitHub and Visual Studio 2022. (A commend window will auto open and close. No action is required)
GH13.png
GitHub Copilot is now authenticated, configured and ready for use.
GH14.png
Continue to the next step.


Modernizing .NET using Azure Migrate and GitHub Copilot tools
1 Hr 30 Min Remaining 
Prepare to scan code using Azure Migrate application and code assessment for .NET
In this step we will use the Azure Migrate application and code assessment for .NET Visual Studio extension to scan code for the devshop web app . This extension provides details about code changes that may be required before the web app is migrated to App Service. For this lab Azure Migrate application and code assessment extension is pre-installed but you can download this extension from https://marketplace.visualstudio.com/items?itemName=ms-dotnettools.appcat

Please note:
* As part of this step we will implement a code related to "Log4Net" in the desvhop application, Details provided below.

*Code changes required for Azure OpenAI integration with sample ASP.NET web app (devshop.sln) are already implemented and no changes are require



In the already open Visual Studio 2022 window and navigate to "solution explorer" (C:\Users\Admin\source\repos\devShop\devShop\devShop.sln ).In the solution explorer Right click on the "devshop" project and click "Re-platform to Azure".
AC1.png
On this screen select "New Report"
AC2.png
For the purpose of this lab Select "Azure App Service (Windows)" as target service on Azure. Click "Next"
AC3.png
By default all projects within the solution are selected. Leave the selection as-is and click "Next"
AC4.png
For purpose of this lab we will analyze source code and settings (you can also include binary dependencies and define custom settings if needed). On this screen leave the default selection as-is and click "Analyze"
AC5.png
Once complete you will be presented with a summary dashbaord.
AC6.png
Click "Aggregate issues" on the left menu.
appcat_aggregate_issues.jpg
Expand the issue "Local.0004".It is reported that devshop has "Logging to local or network path" configured. If you refer to the corresponding web.config file then you will see that this application uses log4net for logging errors to local disk. The severity of this issue is "Mandatory".
Let us fix this issue using GitHub Copilot . Click on "Ask Copilot" on the top right. A new Copilot chat window opens with possible resolution(s) for this issue.
appcat_log4net_1.jpg
appcat_log4net_2.jpg
Based on GitHub Copilot guidance we will implement following changes to the devshop application.
Install "Microsoft.ApplicationInsights.Log4NetAppender" NuGet package. To install this package right click "devshop" project and select "Manage NuGet Packages". Make sure that you are on the "Browse" tab. (Ensure that "All" or "nuget.org" is selected in the "Package source" dropdown on the top right corner.)
Nuget.jpg
Once this package is installed open web.config for devshop project.
webconfig.jpg
In the "web.config" make following changes.

webconfig_2.jpg

Replace existing log4net tag details as shown above with the following changes.

<log4net debug="true">

 <appender name="ApplicationInsightsAppender" type="Microsoft.ApplicationInsights.Log4NetAppender.ApplicationInsightsAppender, Microsoft.ApplicationInsights.Log4NetAppender">
  <layout type="log4net.Layout.PatternLayout">
      <conversionPattern value="%date [%thread] %-5level %logger - %message%newline" />
  </layout>
 </appender>

<root>
    <level value="ALL" />

    <appender-ref ref="ApplicationInsightsAppender"/>

</root>
    </log4net>
Save "web.config" file.

Now Right the "devshop" project and click "Rebuild" solution.
Once "Rebuild" is complete . Once again right click the "devshop" project and click "Publish". This will publish the code changes to localhost.
publish.jpg
Close the issue "Local.0004" . Now expand the issue "Security.0002".It is reported that aoiwebapp has "Connection Strings" defined in the web.config file. Click on "Ask Copilot" on the top right. A new Copilot chat window opens with possible resolution(s) for this issue. (for the purpose of this lab we will not make code changes)
appcat_security0002.jpg
Close Visual Studio

Continue to the next step.

Modernizing .NET using Azure Migrate and GitHub Copilot tools
1 Hr 30 Min Remaining 
Prepare the application for migration
In this step of the lab, you will prepare the application for migration. You will run a PowerShell script that zips up the website for the migration process.

Go back to the PowerShell window that's already open. Run .\Get-SitePackage.ps1 -ReadinessResultsFilePath ReadinessResults.json -PackageResultsFileName "PackageResults.json" -Force . We will omit packaging "Default Web Site" because the assessment results as performed above reported an error.
Run Connect-AzAccount. In the browser window provide Azure username and password from the resources section of the lab.
Prepare the migration settings for the migration script by running .\Generate-MigrationSettings.ps1 -SitePackageResultsPath packagedsites\PackageResults.json -Region northcentralus -SubscriptionId 89c54b68-ea45-4843-9edb-529e2e77baf7 -ResourceGroup Build2025 -Force .
After the script has finished, open the MigrationSettings.json file by running code MigrationSettings.json. Modify the AzureSiteName . From devshop to devshop51501459 and aoiapp to aoiapp51501459 . Remember to change names for both the AzureSiteName variables as shown because the names need to be globally unique for DNS resolution.
Save the file
Continue to the next step.


Modernizing .NET using Azure Migrate and GitHub Copilot tools
1 Hr 18 Min Remaining 
Migrate the application
In this step of the lab, you will migrate your applications to Azure App Service using a PowerShell script. The script sizes the application, creates an app service plan and an app service inside of an existing resource group.

Go back to the PowerShell window that's already open. Run .\Invoke-SiteMigration.ps1 -MigrationSettingsFilePath "MigrationSettings.json" -Force
After the script completes, you can navigate to the Azure Portal to view the migrated application.

Open Microsoft Edge browser.

Please navigate to https://portal.azure.com .

Username: User1-51501459@LODSPRODMCA.onmicrosoft.com

Password: eS0qNr+D8!

Once you have logged in to the Azure Portal , go to Resource Groups by clicking the hamburger menu on top left.
rgs.png

You should now see a resource group named "Build2025" with an app service plan, two app service web apps, an Azure Open AI , Azure App Insights resource and an Azure KeyVault. The app service is now hosting your web application, but it is not yet fully functional.


rgign24.png
ignite24Resources.png

Continue to the next step.

Modernizing .NET using Azure Migrate and GitHub Copilot tools
1 Hr 14 Min Remaining 
Modernize your application with Azure Open AI and App Service Platform Features
We have migrated the two web applications seen in the "Build2025" resource group above. The web app starting with prefix devshop is the primary web application of a fictious ecommerce company named devshop . The devshop company plans to introduce Gen AI capabilities based on Azure Open AI for its devshop web application without completely rewriting and redesigning the existing web application.

We have also migrated the aoiapp web app above. This web application contains the Azure Open AI integration and gets displayed when user clicks on "Chat with AI Assistant" button on the productdetails.aspx page.


productdetails.jpg

Steps 1-4 in this section are optional.

To explore the Azure OpenAI integration navigate to Visual Studio and explore the devShopAOIdapp project. Code changes for Azure OpenAI integration are implemented and no further changes are required.

In this project open the chatbot.aspx page which further references ChatController.cs file.

Following are the Key points about Azure Open AI integration within the ChatController.cs file:

Install Azure OpenAI client library for .NET (https://learn.microsoft.com/en-us/dotnet/api/overview/azure/ai.openai-readme?view=azure-dotnet ) and Azure idenity NuGet pacakage https://www.nuget.org/packages/Azure.Identity
Fetch required Azure Open AI endpoint stored in Azure key Vault
Create Default Azure Credentials to authenticate against the Azure Open AI endpoint using the System Identity (aoiapp )
Finally use ChatClient and ChatCompletion classes to introduce interactive chat capabilities for the devshop web app
Continue to the next step.


packages>
  <package id="Azure.AI.OpenAI" version="2.2.0-beta.4" targetFramework="net48" />
  <package id="Azure.Core" version="1.45.0" targetFramework="net48" />
  <package id="Azure.Identity" version="1.14.0-beta.3" targetFramework="net48" />
  <package id="log4net" version="3.0.5-preview.2" targetFramework="net48" />




using Azure;
using Azure.AI.OpenAI;
using Azure.Identity;
using OpenAI;
using OpenAI.Chat;
using System;
using System.Configuration;
using System.Globalization;
using System.Threading.Tasks;
using System.Web.Http;
  
namespace devShopAOIdapp
{
    public class ChatController : ApiController
    {
        string endpoint = ConfigurationManager.AppSettings["AOIEndpoint"];
        string model = ConfigurationManager.AppSettings["DepName"];
        string systemMessage = ConfigurationManager.AppSettings["SystemMessage"];
  
        AzureOpenAIClient client;
  
        #region IdenityCredentials
        public ChatController()
        {
            var credential = new DefaultAzureCredential();
            client = new AzureOpenAIClient(new Uri(endpoint), credential);
  
        }
  
        #endregion
  
        #region ChatCompletion
  
        [HttpGet]
        public async Task<string> getResponse(string message)
        {
            try
            {
                ChatClient chatClient = client.GetChatClient(model);
  
                ChatCompletion completion = chatClient.CompleteChat(new SystemChatMessage(systemMessage), new UserChatMessage(message));
  
  
                var output = completion.Content[0].Text;
  
                return output;
            }
            catch (Exception ex)
            {
                return ex.Message + ex.StackTrace;
            }
  
        }
        #endregion
    }
}



Modernizing .NET using Azure Migrate and GitHub Copilot tools
1 Hr 7 Min Remaining 
Monitoring
A huge benefit of hosting your site in Azure is the ability to monitor your application and track specific metrics. Azure App Service allows you to easily enable monitoring through the portal to connect your site to Application Insights. Application Insights logs metrics and application telemetry data with features such as Live Metrics, Usage and Smart detection. Follow the steps below to enable Application Insights

Go to App Service (web app prefixed with devshop) in the "Build2025" resource group. Go to Monitoring then to Application Insights. Click the Turn on Application Insights button
log4appinsh_1.jpg
Check the radio button for Select existing resource. Select the "Application Insights" resource with the name prefixed with lab343.
log4appinsh_2.jpg
Hit Apply.
log4appinsh_3.jpg
Once Application Insight resource is connected application logs from Log4Net will now be populated. Navigate to "Application Insight" resource prefixed with lab343 and click "Transaction Search" under "Investigate" menu. Click on "see all data in last 24 hours".
log4appinsh_4.jpg
You should now be able to view application logs. There may be some delay for logs to be populated and displayed. To populate logs browse home page of the "devshop" web app migrated in the previous steps.
log4appinsh_5.jpg
This step showcased important "app modernization" construct where in migrated web app are able to publish application logs to Application Insights without making code changes.

You've now enabled monitoring! Move onto the next steps.

Modernizing .NET using Azure Migrate and GitHub Copilot tools
1 Hr 6 Min Remaining 
Explore Azure Resources and Establish Connectivity with Azure Open AI Resource
Go to App Service web app prefixed with aoiapp within the "Build2025" resource group.

Create a System Assigned Managed Identity for the aoi webapp (App Service web app starting with the prefix aoiapp) through App Service by going to Settings then Identity inside your App Service in the Azure Portal. Turn the button for Status to On and hit Save. Click Yes to save the changes.
system_identity.jpg.
Go to Azure KeyVault prefixed with "lab343" by navigating to the Build2025 resource group.
Go to Access control (IAM), click Add then Add role assignment
Select the KeyVault Secrets User role.
On the next screen, select Managed identity Click +Select members and then select "App Service". You should now see Managed Identity for the webapp prefixed with "aoiapp" from the dropdown and hit Select
Click Review + assign twice. Now your App Service has access to read the secrets in your KeyVault.
Similarly click Add and then Add role assignment select the KeyVault Secrets Officer role. Click +Select members
On the next screen, search for your Azure username,User1-51501459@LODSPRODMCA.onmicrosoft.com.
Click Review + assign twice. Now you have access to manage the secrets in your KeyVault.
Go to Build2025 resource group and click the Azure Open AI resource prefixed with "lab343" and ending with "openai".
openai_1.jpg

Click on "Keys and Endpoint" under "Resource Management" menu. Click "Show Keys"
openai_4.jpg
Open a notepad. Copy and paste the values for "Endpoint" and "Key 1". we will require these for upcoming steps.
Go to Access control (IAM), click Add then Add role assignment
Select the Cognitive Services OpenAI User role.
On the next screen, select Managed identity Click +Select members then select your App Service. You should now see Managed Identity for the webapp prefixed with "aoiapp" from the dropdown and hit Select
Click Review + assign twice. Now your App Service has access to the Azure OpenAI resource.
Click on "Go to Azure AI Foundry Portal" on the "Overview" menu . Azure OpenAI Studio opens up in a new browser tab. This step is optional

Go to "Deployments" under Shared Resources on the left menu

openai_2.jpg
Click on the deployed model "Name".
Explore various model properties like "Content filter", "Rate Limit" . Do not make changes to the existing config.
openai_3.jpg
Continue to the next step.

Modernizing .NET using Azure Migrate and GitHub Copilot tools
1 Hr 4 Min Remaining 
Create secrets in Azure Key Vault and create corresponding App Service App Settings.
Create secrets in the KeyVault by going to your KeyVault prefixed with lab343 then look for Secrets under Objects.
Select Generate/Import. Create a secret named AOIEndpoint. The secret value should be the Azure OpenAI Endpoint that you copied earlier in the format "https://YourAOIName.openai.azure.com/". Hit Create once you've filled out the secret name and value. Once created click the secret named AOIEndpoint and then click the current version of this secret. Copy and paste the "Secret Identifier" for this secret in the notepad . The format will be similar to " https:// YourKVName.vault.azure.net/secrets/AOIEndpoint/…."
Navigate to the App Service web app prefixed with aoiwebapp .Go to the Settings and click "Environmant Variables". You will create single app setting.
Click +Add . Name will be AOIEndpoint and value will be @Microsoft.KeyVault(SecretUri=https://<Your KeyVault name>.vault.azure.net/secrets/<Your Secret name>/). Use the value you pasted in the notepad for corresponding Key Vault secret URI.Click Apply. (Ensure trailing / is added when providing App Setting Value.)
aoiwebapp_appsettings.jpg
Click Apply . This will save the app settings and restart the web app.
Navigate to web app prefixed with devshop. Go to the Settings and click "Environment Variables". You will create 1 app setting.
Click +Add . Name will ChatbotURL and value will be "https://aoiapp###.azurewebsites.net/chatbot.aspx". Please subsitute correct name of the "aoiapp" web app.Click Apply
Click Apply . This will save the app settings and restart the web app.
Once the "devshop###" app has successfully restarted, navigate to the URL for your application and you should be able to see the fully functional app with products listed on the site. Click any product and then click "CHAT WITH AI ASSISTANT!!". A new modal popup will open. Type a query and press submit. You should receive response from Azure OpenAI endpoint.

Continue to the next step.

Modernizing .NET using Azure Migrate and GitHub Copilot tools
1 Hr 4 Min Remaining 
Automatic scaling
In local .NET applications hosted on IIS, you handle scaling through your Application Pools. Azure App Service offers both vertical scaling (upgrading your App Service Plan) and horizontal scaling (creating multiple instances of your app). For the purposes of this lab, we are going to focus on horizontal scaling.

Automatic scaling allows you to be prepared for unexpected spikes in traffic to your site. Let's say your devshop site has unexpected spikes in traffic due an ongoing promotion. Enable automatic scaling by following the steps below to to handle the traffic.

Go to App Service (web app prefixed with devshop) in the "Build2025" resource group. Navigate to Settings then Scale out (App service plan).
automatic_scaling.png
Configure scaling with the following settings:
Scale out method: Automatic
Maximum burst: 3
Always ready instances: 1
Enforce scale out limit: On
Maximum scale limit: 3
Hit Save at the top of the screen. You just setup automatic scaling!

Modernizing .NET using Azure Migrate and GitHub Copilot tools
1 Hr 4 Min Remaining 
Health Check
Azure App Service has a health check feature that helps increase your application's availability by rerouting requests away from unhealthy instances, and replacing instances if they remain unhealthy. Follow the below steps to configure a health check for your migrated application on App Service.

Go to App Service (web app prefixed with devshop) in the "Build2025" resource group.
Go to the Monitoring section and then Health check
Check the enable box to configure the health check.
Configure the health check as /.
Click Save at the top.
healthcheck.jpg
You just enabled a health check for your migrated application!

You have successfully completed first part of this lab excercise.

